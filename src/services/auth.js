// services/auth.js - Versi√≥n con tipo de usuario
import { apiAdmin1, apiAdmin2 } from './api.js';
import router from '@/router';

const TOKEN_KEY = 'api_token';
const CUSTOMER_KEY = 'customer_data';

export const authService = {
    getToken() {
        return localStorage.getItem(TOKEN_KEY);
    },

    setToken(token) {
        // ‚úÖ Validar token antes de guardar
        if (!token || typeof token !== 'string') {
            throw new Error('Token inv√°lido');
        }
        localStorage.setItem(TOKEN_KEY, token);
    },

    getCustomer() {
        try {
            const customerData = localStorage.getItem(CUSTOMER_KEY);
            return customerData ? JSON.parse(customerData) : null;
        } catch (error) {
            // ‚úÖ Manejar JSON corrupto
            console.error('Error parsing customer data:', error);
            localStorage.removeItem(CUSTOMER_KEY);
            return null;
        }
    },

    setCustomer(customer) {
        // ‚úÖ Validar datos antes de guardar
        if (!customer || typeof customer !== 'object') {
            throw new Error('Datos de cliente inv√°lidos');
        }
        // ‚úÖ Filtrar datos sensibles (mantener solo lo necesario) + tipo de usuario
        const safeCustomer = {
            id: customer.id,
            name: customer.name,
            first_last_name: customer.first_last_name,
            second_last_name: customer.second_last_name,
            alias: customer.alias,
            document: customer.document,
            email: customer.email,
            telephone: customer.telephone,
            status: customer.status,
            type: customer.type, // ‚úÖ AGREGAR TIPO DE USUARIO
            // NO guardar passwords u otros datos sensibles
        };
        localStorage.setItem(CUSTOMER_KEY, JSON.stringify(safeCustomer));
    },

    // ‚úÖ NUEVO: M√©todo para obtener solo el tipo de usuario
    getUserType() {
        const customer = this.getCustomer();
        return customer?.type || null;
    },

    isAuthenticated() {
        const token = this.getToken();
        console.log('üîç Verificando autenticaci√≥n:');
        console.log(' - Token:', token ? 'EXISTE' : 'NO EXISTE');
        console.log(' - Longitud token:', token ? token.length : 0);
        const result = !!token;
        console.log(' - Resultado:', result);
        return result;
    },
    async login(source = 'admin2', credentials) {
    try {
        const cleanCredentials = {
            email: String(credentials.email).trim(),
            password: String(credentials.password)
        };

        const api = source === 'admin2' ? apiAdmin2 : apiAdmin1;
        const response = await api.post('/login', cleanCredentials);

        console.log('üì• Respuesta completa del servidor:', response.data);

        const { api_token, data: userData, success, cross_domain_redirect } = response.data;

        if (!success || !api_token || !userData) {
            throw new Error('Login no exitoso seg√∫n el servidor');
        }

        console.log('‚úÖ Token recibido:', api_token);
        console.log('‚úÖ Redirecci√≥n cross-domain:', cross_domain_redirect);

        // ‚úÖ VERIFICACI√ìN CR√çTICA: Asegurarnos que cross_domain_redirect existe
        if (!cross_domain_redirect) {
            console.error('‚ùå ERROR: cross_domain_redirect es null o undefined');
            throw new Error('No se recibi√≥ URL de redirecci√≥n del servidor');
        }

        // Guardar token para Vue (por si acaso)
        this.setToken(api_token);
        this.setCustomer(userData);

        // ‚úÖ CORRECCI√ìN DEFINITIVA: Redirigir DIRECTAMENTE sin intermediarios
        console.log('üîÑ REDIRIGIENDO DIRECTAMENTE a:', cross_domain_redirect);
        
        // Usar location.replace para evitar que el usuario pueda volver atr√°s
        window.location.replace(cross_domain_redirect);
        
        return {
            success: true,
            redirecting: true,
            redirectUrl: cross_domain_redirect
        };

    } catch (error) {
        console.error('‚ùå Error en login:', error.message);
        
        if (error.response) {
            console.error('Status:', error.response.status);
            console.error('Data:', error.response.data);
        }
        
        throw error;
    }
},
    async logout(source = 'admin2') {
        try {
            const api = source === 'admin2' ? apiAdmin2 : apiAdmin1;
            const token = this.getToken();
            
            if (token) {
                await api.post('/logout');
            }
        } catch (error) {
            console.error('Error durante logout:', error.message);
        } finally {
            this.clearSession();
        }
    },

    clearSession() {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(CUSTOMER_KEY);
    },

    redirectToLogin() {
        this.clearSession();
        router.push('/login');
    }
};
